<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloud Computing Project - API Test Client</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.0/build/qrcode.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDummy"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            color: white;
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        .modules {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .module {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .module h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
            font-family: inherit;
        }
        .form-group textarea {
            resize: vertical;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 600;
            transition: background 0.3s;
            width: 100%;
        }
        .btn:hover {
            background: #764ba2;
        }
        .response {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }
        .response h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .response pre {
            background: #222;
            color: #0f0;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            font-size: 0.85em;
        }
        .response.success {
            border-left-color: #4caf50;
        }
        .response.error {
            border-left-color: #f44336;
        }
        .response.error pre {
            color: #ff6b6b;
        }
        .qr-display {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .qr-display #qrcode {
            display: inline-block;
        }
        .config {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .config h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        .status {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        .status.ok {
            background: #4caf50;
            color: white;
        }
        .status.error {
            background: #f44336;
            color: white;
        }
        .gps-map {
            width: 100%;
            height: 300px;
            border-radius: 5px;
            margin-top: 15px;
        }
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .two-col input {
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚òÅÔ∏è Cloud Computing Project</h1>
            <p>API Test Client - Versi A (Google Apps Script)</p>
        </div>

        <!-- CONFIG -->
        <div class="config">
            <h2>‚öôÔ∏è Konfigurasi</h2>
            <div class="form-group">
                <label>Base URL (Apps Script Deployment URL)</label>
                <input type="url" id="baseUrl" placeholder="https://script.google.com/macros/s/AKfycbxc41HftvQwres7dfVwCsy70uIIVvrRgHhelpEoPKhWaOUN6AyHmFMIP8qrgpww2CIIbg/exec" value="https://script.google.com/macros/s/AKfycbxc41HftvQwres7dfVwCsy70uIIVvrRgHhelpEoPKhWaOUN6AyHmFMIP8qrgpww2CIIbg/exec">
            </div>
            <div class="form-group">
                <label style="margin-top: 10px;">Status Koneksi: <span id="statusBadge" class="status error">Belum Terhubung</span></label>
            </div>
        </div>

        <!-- MODULES -->
        <div class="modules">
            <!-- MODULE 1: PRESENSI QR -->
            <div class="module">
                <h2>üé´ Presensi QR Dinamis</h2>
                
                <h3 style="margin-top: 20px; margin-bottom: 15px; color: #666; font-size: 0.9em;">1. Generate QR Token</h3>
                <div class="form-group">
                    <label>Course ID</label>
                    <input type="text" id="qr_courseId" placeholder="cloud-101" value="cloud-101">
                </div>
                <div class="form-group">
                    <label>Session ID</label>
                    <input type="text" id="qr_sessionId" placeholder="sesi-02" value="sesi-02">
                </div>
                <button class="btn" onclick="generateQR()">Generate QR Token</button>
                <div id="qrResponse" class="response" style="display:none;"></div>
                
                <div class="qr-display" id="qrDisplay" style="display:none;">
                    <div id="qrcode"></div>
                    <p style="margin-top: 10px; color: #666;">Scan QR di atas untuk dapatkan token</p>
                </div>

                <hr style="margin: 20px 0; opacity: 0.3;">

                <h3 style="margin-bottom: 15px; color: #666; font-size: 0.9em;">2. Check-in (Scan QR)</h3>
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="checkin_userId" placeholder="2023xxxx" value="2023001">
                </div>
                <div class="form-group">
                    <label>Device ID</label>
                    <input type="text" id="checkin_deviceId" placeholder="dev-001" value="dev-001">
                </div>
                <div class="form-group">
                    <label>Course ID</label>
                    <input type="text" id="checkin_courseId" placeholder="cloud-101" value="cloud-101">
                </div>
                <div class="form-group">
                    <label>Session ID</label>
                    <input type="text" id="checkin_sessionId" placeholder="sesi-02" value="sesi-02">
                </div>
                <div class="form-group">
                    <label>QR Token (dari generate atau scan)</label>
                    <input type="text" id="checkin_token" placeholder="TKN-ABC123">
                </div>
                <button class="btn" onclick="performCheckin()">Check-in</button>
                <div id="checkinResponse" class="response" style="display:none;"></div>

                <hr style="margin: 20px 0; opacity: 0.3;">

                <h3 style="margin-bottom: 15px; color: #666; font-size: 0.9em;">3. Cek Status</h3>
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="status_userId" placeholder="2023xxxx" value="2023001">
                </div>
                <div class="form-group">
                    <label>Course ID</label>
                    <input type="text" id="status_courseId" placeholder="cloud-101" value="cloud-101">
                </div>
                <div class="form-group">
                    <label>Session ID</label>
                    <input type="text" id="status_sessionId" placeholder="sesi-02" value="sesi-02">
                </div>
                <button class="btn" onclick="checkPresenceStatus()">Cek Status</button>
                <div id="statusResponse" class="response" style="display:none;"></div>
            </div>

            <!-- MODULE 2: ACCELEROMETER -->
            <div class="module">
                <h2>üìä Accelerometer</h2>

                <h3 style="margin-bottom: 15px; color: #666; font-size: 0.9em;">1. Kirim Data Batch</h3>
                <div class="form-group">
                    <label>Device ID</label>
                    <input type="text" id="accel_deviceId" placeholder="dev-001" value="dev-001">
                </div>
                <div class="two-col">
                    <div class="form-group">
                        <label>X (G)</label>
                        <input type="number" id="accel_x" placeholder="0.12" value="0.12" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Y (G)</label>
                        <input type="number" id="accel_y" placeholder="0.01" value="0.01" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label>Z (G)</label>
                    <input type="number" id="accel_z" placeholder="9.70" value="9.70" step="0.01">
                </div>
                <button class="btn" onclick="sendAccelData()">Kirim Data Accelerometer</button>
                <div id="accelSendResponse" class="response" style="display:none;"></div>

                <hr style="margin: 20px 0; opacity: 0.3;">

                <h3 style="margin-bottom: 15px; color: #666; font-size: 0.9em;">2. Ambil Data Terbaru</h3>
                <div class="form-group">
                    <label>Device ID</label>
                    <input type="text" id="accelLatest_deviceId" placeholder="dev-001" value="dev-001">
                </div>
                <button class="btn" onclick="getAccelLatest()">Ambil Data Terbaru</button>
                <div id="accelLatestResponse" class="response" style="display:none;"></div>
            </div>

            <!-- MODULE 3: GPS -->
            <div class="module">
                <h2>üìç GPS Tracking</h2>

                <h3 style="margin-bottom: 15px; color: #666; font-size: 0.9em;">1. Log GPS Point</h3>
                <div class="form-group">
                    <label>Device ID</label>
                    <input type="text" id="gps_deviceId" placeholder="dev-001" value="dev-001">
                </div>
                <div class="two-col">
                    <div class="form-group">
                        <label>Latitude</label>
                        <input type="number" id="gps_lat" placeholder="-7.2575" value="-7.2575" step="0.0001">
                    </div>
                    <div class="form-group">
                        <label>Longitude</label>
                        <input type="number" id="gps_lng" placeholder="112.7521" value="112.7521" step="0.0001">
                    </div>
                </div>
                <div class="form-group">
                    <label>Accuracy (meter)</label>
                    <input type="number" id="gps_accuracy" placeholder="12.5" value="12.5" step="0.1">
                </div>
                <button class="btn" onclick="sendGPSData()">Log GPS Point</button>
                <div id="gpsSendResponse" class="response" style="display:none;"></div>

                <hr style="margin: 20px 0; opacity: 0.3;">

                <h3 style="margin-bottom: 15px; color: #666; font-size: 0.9em;">2. Ambil GPS Terbaru (Marker)</h3>
                <div class="form-group">
                    <label>Device ID</label>
                    <input type="text" id="gpsLatest_deviceId" placeholder="dev-001" value="dev-001">
                </div>
                <button class="btn" onclick="getGPSLatest()">Ambil GPS Terbaru</button>
                <div id="gpsLatestResponse" class="response" style="display:none;"></div>

                <hr style="margin: 20px 0; opacity: 0.3;">

                <h3 style="margin-bottom: 15px; color: #666; font-size: 0.9em;">3. Ambil GPS History (Polyline)</h3>
                <div class="form-group">
                    <label>Device ID</label>
                    <input type="text" id="gpsHistory_deviceId" placeholder="dev-001" value="dev-001">
                </div>
                <div class="form-group">
                    <label>Limit</label>
                    <input type="number" id="gpsHistory_limit" placeholder="200" value="200" min="1">
                </div>
                <button class="btn" onclick="getGPSHistory()">Ambil GPS History</button>
                <div id="gpsHistoryResponse" class="response" style="display:none;"></div>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = () => document.getElementById('baseUrl').value;

        function showResponse(elementId, data, isError = false) {
            const el = document.getElementById(elementId);
            el.className = `response ${isError ? 'error' : 'success'}`;
            el.innerHTML = `<h3>${isError ? '‚ùå Error' : '‚úÖ Success'}</h3><pre>${JSON.stringify(data, null, 2)}</pre>`;
            el.style.display = 'block';
        }

        // PRESENSI QR
        async function generateQR() {
            const data = {
                course_id: document.getElementById('qr_courseId').value,
                session_id: document.getElementById('qr_sessionId').value,
                ts: new Date().toISOString()
            };

            try {
                const response = await fetch(BASE_URL() + '/presence/qr/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showResponse('qrResponse', result, !result.ok);

                if (result.ok) {
                    // Generate QR Code visual
                    const token = result.data.qr_token;
                    document.getElementById('qrcode').innerHTML = '';
                    QRCode.toCanvas(document.getElementById('qrcode'), token, { width: 200 }, alert);
                    document.getElementById('qrDisplay').style.display = 'block';
                    document.getElementById('checkin_token').value = token;
                }
            } catch (error) {
                showResponse('qrResponse', { error: error.message }, true);
            }
        }

        async function performCheckin() {
            const data = {
                user_id: document.getElementById('checkin_userId').value,
                device_id: document.getElementById('checkin_deviceId').value,
                course_id: document.getElementById('checkin_courseId').value,
                session_id: document.getElementById('checkin_sessionId').value,
                qr_token: document.getElementById('checkin_token').value,
                ts: new Date().toISOString()
            };

            try {
                const response = await fetch(BASE_URL() + '/presence/checkin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showResponse('checkinResponse', result, !result.ok);
            } catch (error) {
                showResponse('checkinResponse', { error: error.message }, true);
            }
        }

        async function checkPresenceStatus() {
            const userId = document.getElementById('status_userId').value;
            const courseId = document.getElementById('status_courseId').value;
            const sessionId = document.getElementById('status_sessionId').value;

            try {
                const url = BASE_URL() + `/presence/status?user_id=${userId}&course_id=${courseId}&session_id=${sessionId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResponse('statusResponse', result, !result.ok);
            } catch (error) {
                showResponse('statusResponse', { error: error.message }, true);
            }
        }

        // ACCELEROMETER
        async function sendAccelData() {
            const data = {
                device_id: document.getElementById('accel_deviceId').value,
                ts: new Date().toISOString(),
                samples: [{
                    t: new Date().toISOString(),
                    x: parseFloat(document.getElementById('accel_x').value),
                    y: parseFloat(document.getElementById('accel_y').value),
                    z: parseFloat(document.getElementById('accel_z').value)
                }]
            };

            try {
                const response = await fetch(BASE_URL() + '/telemetry/accel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showResponse('accelSendResponse', result, !result.ok);
            } catch (error) {
                showResponse('accelSendResponse', { error: error.message }, true);
            }
        }

        async function getAccelLatest() {
            const deviceId = document.getElementById('accelLatest_deviceId').value;
            try {
                const url = BASE_URL() + `/telemetry/accel/latest?device_id=${deviceId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResponse('accelLatestResponse', result, !result.ok);
            } catch (error) {
                showResponse('accelLatestResponse', { error: error.message }, true);
            }
        }

        // GPS
        async function sendGPSData() {
            const data = {
                device_id: document.getElementById('gps_deviceId').value,
                ts: new Date().toISOString(),
                lat: parseFloat(document.getElementById('gps_lat').value),
                lng: parseFloat(document.getElementById('gps_lng').value),
                accuracy_m: parseFloat(document.getElementById('gps_accuracy').value)
            };

            try {
                const response = await fetch(BASE_URL() + '/telemetry/gps', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                showResponse('gpsSendResponse', result, !result.ok);
            } catch (error) {
                showResponse('gpsSendResponse', { error: error.message }, true);
            }
        }

        async function getGPSLatest() {
            const deviceId = document.getElementById('gpsLatest_deviceId').value;
            try {
                const url = BASE_URL() + `/telemetry/gps/latest?device_id=${deviceId}`;
                const response = await fetch(url);
                const result = await response.json();
                showResponse('gpsLatestResponse', result, !result.ok);
            } catch (error) {
                showResponse('gpsLatestResponse', { error: error.message }, true);
            }
        }

        async function getGPSHistory() {
            const deviceId = document.getElementById('gpsHistory_deviceId').value;
            const limit = document.getElementById('gpsHistory_limit').value;
            try {
                const url = BASE_URL() + `/telemetry/gps/history?device_id=${deviceId}&limit=${limit}`;
                const response = await fetch(url);
                const result = await response.json();
                showResponse('gpsHistoryResponse', result, !result.ok);
            } catch (error) {
                showResponse('gpsHistoryResponse', { error: error.message }, true);
            }
        }
    </script>
</body>
</html>
